<!doctype html>
<!--[if lt IE 7]>
<html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>
<html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>
<html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Jonathan & Rosanna getting hitched!</title>
    <meta name="description" content="We would like to invite you to our big day.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff">
    <meta property="og:title" content="Rosanna & Jonathan getting hitched">
    <meta property="og:description" content="We would like to invite you to our big day.">
    <meta property="og:image" content="../img/0081.jpg">
    <meta property="og:type" content="website">
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
    <link rel="manifest" href="../manifest.json">
    <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">

    <script>
        // load css files from CDN if local node_modules fail
        function loadCssFromCDN(css) {
            // create new link tag
            const link = document.createElement('link');
            if (css === 'animate.css') {
                link.href = 'https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.2/animate.min.css';
            } else if (css === 'font-awesome.css') {
                link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css';
            }
            link.rel = 'stylesheet';

            // add link tag to head section
            document.getElementsByTagName('head')[0].appendChild(link);
        }

        // load js files from CDN if local node_modules fail
        function loadJsFromCDN(js) {
            if (js === 'waypoints.js') {
                document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.js"><\/script>');
            } else if (js === 'jquery.js') {
                document.write('<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"><\/script>');
            }
        }
    </script>

    <link rel="stylesheet" href="../css/normalize.min.css">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/jquery.fancybox.css">
    <link rel="stylesheet" href="../css/flexslider.css">
    <link rel="stylesheet" href="../css/styles.min.css">
    <link rel="stylesheet" href="../css/queries.css">
    <link rel="stylesheet" href="../node_modules/animate.css/animate.min.css" onerror="loadCssFromCDN('animate.css')">
    <link rel="stylesheet" href="../node_modules/font-awesome/css/font-awesome.min.css" onerror="loadCssFromCDN('font-awesome.css')">
    <script src="../js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
</head>
<body id="top">
<section class="hero">
    <section class="navigation">
        <header>
            <div class="header-content fancybox">
                <div class="logo"><a href="#"><img src="../img/logo.png" alt="Logo"></a></div>
                <div class="header-nav">
                    <nav>
                        <ul class="primary-nav">
                            <li><a href="../index.html#intro">How we met</a></li>
                            <li><a href="../index.html#events">Events</a></li>
                            <li><a href="../index.html#eng-pics">Visual Story</a></li>
                            <li><a href="album.html#eng-pics">Engagement Album</a></li>
                            <li class="hidden-sm hidden-xs"><a href="../index.html#video-bg">Glimpse of the city</a></li>
                        </ul>
                        <ul class="member-actions">
                            <li><a href="../index.html#map" class="login">Venue</a></li>
                        </ul>
                    </nav>
                </div>
                <div class="navicon">
                    <a class="nav-toggle" href="#"><span></span></a>
                </div>
            </div>
        </header>
    </section>
    <div class="container">
        <div class="row">
            <div class="col-md-10 col-md-offset-1">
                <div class="hero-content text-center">
                    <img src="../img/logo-lg.png" alt="Jonathan & Zan">
                </div>
            </div>
        </div>
    </div>
    <div class="down-arrow floating-arrow"><a href="#rsvp-response"><i class="fa fa-angle-down"></i></a></div>
</section>
 


<section id="rsvp-final" class="rsvp-final text-center">
    <div class="container">
        <div class="row">
            <h3>RSVP</h3>
            <div id="validation-code"></div>
            <div id="here">
                <img src="../img/fancybox_loading.gif" alt=""/>
            </div>
        </div>
    </div>
</section>



<footer>
    <div class="container">
        <div class="row">
            <div class="col-sm-12 text-center content">
                <span class="to-top-wrapper"><a href="#top" class="to-top"><i class="fa fa-angle-up"></i></a></span>
                <p>Crafted by Zanathan</p>
            </div>
        </div>
    </div>
</footer>
<script src="../js/vendor/jquery-1.11.2.min.js" onerror="loadJsFromCDN('jquery.js')"></script>
<script src="../node_modules/waypoints/lib/jquery.waypoints.min.js" onerror="loadJsFromCDN('waypoints.js')"></script>
<script src="../js/jquery.fancybox.pack.js"></script>
<script src="../js/vendor/bootstrap.min.js"></script>
<script src="../js/jquery.flexslider-min.js"></script>
<script src="../js/jquery.mb.YTPlayer.min.js"></script>
<script src="../js/vendor/ouical.js"></script>
<script src="../js/scripts.min.js"></script>
<script src="../js/scripts.min.js"></script>
<script>
    var data_div = function (valid_data){
        var innerHtml = `<form id="rsvp-submission" class="rsvp-submission">
            `;
        valid_data.data.forEach(function (item, index) {
            console.log(item.rsvp===true);
            checked="";
            if(item.rsvp===true){
                checked = "checked";
            }
            innerHtml += `<div class="rsvp-submission-input-group">
                            <input type="text" name="name" id="name-`+index+`"                              
                                placeholder="Name" required value="`+item.name+`">
                        </div>
                        <div class="rsvp-submission-input-group">
                            <input type="text" name="surname" id="surname-`+index+`"                              
                                placeholder="Surname" required value="`+item.surname+`">
                        </div>
                        <div class="rsvp-submission-input-group">
                            <input type="text" name="email" id="email-`+index+`"                              
                                placeholder="Email address" required value="`+item.email+`">
                        </div>
                        <div class="rsvp-submission-input-group">
                            <input type="checkbox" name="rsvp_checkbox" id="rsvp-`+index+`" title="Tick the box to mark as attending."
                                required `+checked+`>
                        </div>
                        <div class="rsvp-submission-input-group">
                            <input type="text" name="menu" id="menu-`+index+`"
                                placeholder="Menu" required value="`+item.menu+`">
                        </div>
                        <div class="rsvp-submission-input-group">
                            <input type="text" name="song" id="song_request-`+index+`"
                                placeholder="Song Request. It probably won't play but if you had a song you want to hear put it here." required value="`+item.song_request+`">
                        </div>
                        `
        });
        innerHtml += `<button type="button" id="button-0" class="btn-fill rsvp-submission-btn" onclick="on_data_submit()">
                            Submit
                        </button>
                    </form>
                    `
        return innerHtml;
    }

    var data_from_code = function (code) {
        var app_url = "https://script.google.com/macros/s/AKfycbxH95kr0KyKgrcj16YKH6UTRl_Y_GhGCJt9FFOSJnkFrQscAP4F_vFiXqpZaWyaOUw/exec";
        app_url = app_url + "?code=" + code + "&verifyonly=" + false;
        var data_response = {};
        $.ajax({
            url: app_url,
            method: "GET",
            async: false,
            dataType: "json",
            success: function (response) {
                data_response = response
            },
            error: function () {
                alert("The form failed. Please let Jonathan know and try again later.")
                data_response = {}
            }
        });
        return data_response;
    };

    window.onload = function () {
        var url = document.location.href,
            params = url.split('?')[1].split('&'),
            data = {}, tmp;
        for (var i = 0, l = params.length; i < l; i++) {
             tmp = params[i].split('=');
             data[tmp[0]] = tmp[1];
        }
        var valid_data = data_from_code(data.id);
        document.getElementById('validation-code').value = data.id;
        var innerHtml = "That is not a valid code!"
        if (valid_data.valid === true){
            innerHtml = data_div(valid_data);
        }
        document.getElementById('here').innerHTML = innerHtml;
    };

    var on_data_submit = function (e) {
        var elements = document.getElementById('rsvp-submission').elements;
        var code = parseInt(document.getElementById('validation-code').value);
        var data = [];
        for (var i = 0; i < elements.length; i++){
            var id = elements[i].id.split('-');
            var title = id[0];
            var pos = parseInt(id[1]);
            var dict = {
                "validation_code": code,
                "plus_one_allowed": false
            };
            
            if(title !== 'button'){
                if(data.length<=pos){
                    data[pos] = dict;
                }
                else{
                    dict = data[pos];
                }

                if( title === 'rsvp'){
                    dict[title] = elements[i].checked;
                }
                else{
                    dict[title] = elements[i].value;
                }
                data[pos] = dict
            }
        }
        rsvp_data = {
            "code": code,
            "rsvps": data,
            "plus_ones": []
        }
        update_rsvp_details(rsvp_data);
            
        window.location.href = "rsvp.html?id="+encodeURIComponent(code);
    };

    // update details
    var update_rsvp_details = function (data) {
        var app_url = "https://script.google.com/macros/s/AKfycbxH95kr0KyKgrcj16YKH6UTRl_Y_GhGCJt9FFOSJnkFrQscAP4F_vFiXqpZaWyaOUw/exec";
        $.ajax({
            url: app_url,
            method: "POST",
            async: false,
            dataType: "json",
            data: JSON.stringify(data),
            success: function () {
                alert("The form was submitted successfully.")
            },
            error: function () {
                alert("The form failed. Please let Jonathan know and try again later.")
            }
        });
    };
</script>  
<!-- Google Analytics -->
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-46465113-4', 'auto');
    ga('send', 'pageview');
</script>
</body>
</html>
